!function(a,b,c,d){function e(b,c){return $.ajax({url:a.ib+b,type:"post",dataType:"json",data:$.extend({m:Math.random()},c)})}function f(){var a=s.getValue().pop(),b=t.getValue().pop(),c=$("#platform").val();return{platformId:c,catId:a?a.catId:0,extCatId:b?b.catId:0}}function g(){var b=f();if(!b.platformId||!b.catId||!b.extCatId)return void $.alert("请选择类目！");$("#propMap").html('<div class="alert alert-warning text-center">正在加载。。。</div>');var c=0,d=2,g=null,i=null,j=function(){++c>=d&&h(g,i)};o.xhrArr[0]=e("/cat/relation/ajax_get_props",{cat_id:b.catId,platform_id:a.wpid}).done(function(a){0==a.error&&(g=a.error_tip),j()}),o.xhrArr[1]=e("/cat/relation/ajax_get_props",{cat_id:b.extCatId,platform_id:b.platformId}).done(function(a){0==a.error&&(i=a.error_tip),j()})}function h(a,b){if(!(a&&a.length&&b&&b.length))return $("#propMap").html('<div class="alert alert-danger text-center">很抱歉，没有可供对应的属性！</div>');for(var c=i(a),d="",e=0,f=b.length;f>e;e++){var g=b[e],h="ext_"+g.id;d+='<div class="panel panel-info" data-ext-prop-id="'+g.pid+'" data-must="'+g.is_must_prop+'" data-ext-pname="'+g.name+'"><div class="panel-heading propMap-title"><form class="form-inline"><a href="#'+h+'" data-toggle="collapse" class="btn-collapse"> <sapn class="glyphicon glyphicon-plus"></sapn></a><div class="form-group"><label class="control-label">万物属性</label>'+c+'</div><span class="gap glyphicon glyphicon-transfer"></span><div class="form-group"><label class="control-label">平台属性</label><span class="platform-prop-text'+("1"==g.is_must_prop?" require-after":"")+'">'+g.name+'</span></div></form></div><div id="'+h+'" class="collapse"><div class="panel-body"><div class="alert alert-warning text-center">请选择属性！</div></div></div></div>'}$("#propMap").html(d)}function i(a){for(var b='<select class="form-control select-prop"><option value="">请选择</option>',c=0,d=a.length;d>c;c++){var e=a[c];b+='<option value="'+e.pid+'">'+e.name+"</option>"}return b+="</select>"}function j(a){if(!a.hasClass("loaded")){var b=a.find(".select-prop"),c=b.val();if(c){var d=a.data("ext-prop-id"),g=f();a.find(".panel-body").html('<div class="alert alert-warning text-center">正在加载。。。</div>'),b.prop("disabled",!0),p=e("/cat/relation/ajax_get_props_value",{third_cat_id:g.extCatId,platform_id:g.platformId,third_pid:d,wanwu_cat_id:g.catId,wanwu_pid:c}).done(function(c){b.prop("disabled",!1),0==c.error&&(a.addClass("loaded"),a.find(".panel-body").html(k(c.list)))})}}}function k(a){var b=a.wanwu,c=a.third;if(!(b&&b.length&&c&&c.length))return'<div class="alert alert-danger text-center">很抱歉，没有可供对应的属性值！</div>';for(var d='<select class="form-control select-value"><option value="">请选择</option>',e=0,f=b.length;f>e;e++){var g=b[e];d+='<option value="'+g.vid+'">'+g.name+"</option>"}d+="</select>";for(var h='<ul class="list-group">',e=0,f=c.length;f>e;e++){var i=c[e],j=l(i);h+='<li class="list-group-item" data-value-id="'+j.vid+'" data-ext-vname="'+i.name+'"><form class="form-inline"><div class="form-group"><label class="control-label">万物属性值</label>'+d+'</div><span class="gap glyphicon glyphicon-transfer"></span><div class="form-group"><label class="control-label">平台属性值</label><span class="platform-prop-text">'+i.name+"</span></div></form></li>"}return h+="</ul>"}function l(a){return a.child_list&&a.child_list.length>0?a.child_list[0]:a}function m(){p&&p.abort(),o&&o.abort(),$("#propMap").html('<div id="loadProperties" class="alert alert-warning text-center">点击加载属性</div>')}function n(){var a=[],b=!0,c=f();return c.platformId&&c.catId&&c.extCatId?($("#propMap").children(".panel").each(function(){var c=$(this),d=c.find(".select-prop").val(),e=c.data("ext-prop-id"),f=+c.data("must"),g=c.hasClass("loaded"),h=null;return!d&&f?(b=!1,void c.addClass("has-error panel-danger")):(g&&(h=c.find("li.list-group-item").map(function(){var a=$(this),b=a.find(".select-value").val()||0;return{vid:b,ext_vid:a.data("value-id"),vname:b?a.find("option[value="+b+"]").text():"",ext_vname:a.data("ext-vname")}}).toArray()),void a.push({prop_id:d,ext_prop_id:e,name:d?c.find(".select-prop>option[value="+d+"]").text():"",extName:c.data("ext-pname"),values:h}))}),void(b&&a.length&&e("/cat/relation/relation_props_value_multiple",{map:JSON.stringify({props:a,cat_id:c.catId,ext_cat_id:c.extCatId,platform_id:c.platformId})}).done(function(a){0==a.error&&$.alert("保存成功!")}))):void $.alert("请选择类目！")}var o={xhrArr:[],abort:function(){for(var a=null;a=this.xhrArr.shift();)a.abort()}},p=null,q={title:"选择万物分类",viewTitle:"点击选择类目",view:"#wanwuCatalog",provider:function(a,b){e("/cat/relation/ajax_get_category_list",{category_id:a?a.catId:0,m:Math.random()}).done(function(a){b(a)})},adapter:function(a){return{hasChild:!0,text:a.catName}},change:m},r={title:"选择平台分类",viewTitle:"点击选择类目",view:"#platformCatalog",provider:function(a,b){var c=$("#platform").val();return c?void e("/cat/relation/ajax_get_platform_category",{platformId:c,cat_id:a?a.catId:0}).done(function(a){"0"==a.error_no&&b(a.list)}):void b(null)},adapter:function(a){return{hasChild:!0,text:a.catName}},change:m},s=new CatalogSelector($.extend({},q)),t=new CatalogSelector($.extend({},r));$("#platform").change(function(){t.reset(),m()}),$("#btn_relationCatalog").click(function(){var a=f();e("/cat/relation/index",{platform_id:a.platformId,wanwu_cat_id:a.catId,third_cat_id:a.extCatId}).done(function(a){0==a.error?g():$.alert("关联失败："+a.error_tip)})}),$(d).on("show.bs.collapse hide.bs.collapse",function(a){var b=$(a.target).parents(".panel:first");switch(jqSpan=b.find("a.btn-collapse").children(),jqSpan.removeClass("glyphicon-plus glyphicon-minus"),a.type){case"show":jqSpan.addClass("glyphicon-minus"),j(b);break;case"hide":jqSpan.addClass("glyphicon-plus")}}).on("change","select",function(a){var b=$(a.target),c=b.parents(".panel:first"),d=b.val();b.toggleClass("hasValue",!!d),c.removeClass("has-error panel-danger")}).on("change",".select-prop",function(){var a=$(this),b=a.parents(".panel:first"),c=b.find(".collapse");c.hasClass("in")&&j(b.removeClass("loaded"))}).on("click","#loadProperties",g),$("#saveProp").click(n)}(function(){for(var a=document.getElementsByTagName("script"),b=a[a.length-1],c=b.src,d=/(?:\?|&)(\w+)=(.+?)(?=&|$)/gi,e=null,f={};e=d.exec(c);)f[e[1]]=e[2];return f}(),window,document,document.body);
/* sm0king 最后修改于：2015-07-09 */
